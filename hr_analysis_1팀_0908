import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import koreanize_matplotlib # í•œê¸€/ë§ˆì´ë„ˆìŠ¤ ìë™ ì„¤ì •

# í•œê¸€ í°íŠ¸ ì„¤ì •
plt.rcParams['font.family'] = "NanumGothic"
plt.rcParams['axes.unicode_minus'] = False

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="í‡´ì§ìœ¨ ëŒ€ì‹œë³´ë“œ", layout="wide")
sns.set(style="whitegrid")

# --- 1) ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ---
@st.cache_data
def load_df(path:str ="HR Data.csv") -> pd.DataFrame:
    try:
        df = pd.read_csv(path, encoding="utf-8")
    except FileNotFoundError:
        return pd.DataFrame() 

    df["í‡´ì§"] = df["í‡´ì§ì—¬ë¶€"].map({"Yes":1, "No":0}).astype("int8")
    df.drop(['ì§ì›ìˆ˜', '18ì„¸ì´ìƒ'], axis=1, inplace=True)
    
    return df

df = load_df()
if df.empty:
    st.error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. 'HR Data.csv' íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
    st.stop()

# ===== KPI Â =====
# 1) í—¤ë” & KPI
st.title("í‡´ì§ìœ¨ ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸")

# KPI(í•µì‹¬ ì„±ê³¼ ì§€í‘œ) ê³„ì‚°
n = len(df)
quit_n = int(df["í‡´ì§"].sum())
quit_rate = df["í‡´ì§"].mean()*100
stay_rate = 100 - quit_rate

# KPI ì—´ ë°°ì¹˜
k1, k2, k3, k4 = st.columns(4)
k1.metric("ì „ì²´ ì§ì› ìˆ˜", f"{n:,}ëª…")
k2.metric("í‡´ì§ì ìˆ˜", f"{quit_n:,}ëª…")
k3.metric("ìœ ì§€ìœ¨", f"{stay_rate:.1f}%")
k4.metric("í‡´ì§ìœ¨", f"{quit_rate:.1f}%")

# --- ê·¸ë˜í”„ 1: ì „ê³µë³„ í‡´ì§ìœ¨ (íŒŒì´ ì°¨íŠ¸) ---
if "ì „ê³µ" in df.columns:
    major_quit_rate = (df.groupby("ì „ê³µ")["í‡´ì§"].mean()*100)
    
    st.subheader("ì§ì› ì „ê³µë³„ í‡´ì§ìœ¨")
    
    fig1, ax1 = plt.subplots(figsize=(10, 5))
    
    ax1.pie(major_quit_rate, labels=major_quit_rate.index, autopct='%.1f%%', startangle=90, colors=sns.color_palette("Set2"))
    ax1.axis('equal')
    
    st.pyplot(fig1)

# --- ê·¸ë˜í”„ 2/3: ë‘ ì¹¼ëŸ¼ìœ¼ë¡œ ë¶„í•  ---
c1, c2 = st.columns(2)

# (ì¢Œ) ê·¸ë˜í”„ 2: ê²°í˜¼ì—¬ë¶€ë³„ í‡´ì§ìœ¨ (ë„ë„› ì°¨íŠ¸)
col_name = "ê²°í˜¼ì—¬ë¶€"
if col_name in df.columns:
    marital_quit_rate = df.groupby(col_name)["í‡´ì§"].mean()*100
    
    with c1:
        st.subheader("â¤ï¸ ê²°í˜¼ì—¬ë¶€ë³„ í‡´ì§ìœ¨")
        fig2, ax2 = plt.subplots(figsize=(6.5, 3.5))
        
        ax2.pie(marital_quit_rate, labels=marital_quit_rate.index, autopct='%.1f%%', 
                wedgeprops={'width': 0.3}, startangle=90, colors=['#ff9999','#66b3ff'])
        ax2.axis('equal')
        
        st.pyplot(fig2)

# (ìš°) ê·¸ë˜í”„ 3: ì„±ë³„ í‡´ì§ìœ¨ (ë§‰ëŒ€ ê·¸ë˜í”„)
col_name = "ì„±ë³„"
if col_name in df.columns:
    gender_quit_rate = df.groupby(col_name)["í‡´ì§"].mean()*100
    
    with c2:
        st.subheader("ğŸ‘« ì„±ë³„ í‡´ì§ìœ¨")
        fig3, ax3 = plt.subplots(figsize=(6.5, 3.5))
        sns.barplot(x=gender_quit_rate.index, y=gender_quit_rate.values, ax=ax3, palette="Pastel1")
        ax3.set_ylabel("í‡´ì§ìœ¨(%)")
        ax3.bar_label(ax3.containers[0], fmt="%.1f%%")
        st.pyplot(fig3)
