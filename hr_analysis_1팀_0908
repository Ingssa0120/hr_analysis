import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import koreanize_matplotlib # 한글/마이너스 자동 설정

# 한글 폰트 설정
plt.rcParams['font.family'] = "NanumGothic"
plt.rcParams['axes.unicode_minus'] = False

# 페이지 설정
st.set_page_config(page_title="퇴직율 대시보드", layout="wide")
sns.set(style="whitegrid")

# --- 1) 데이터 로드 함수 ---
@st.cache_data
def load_df(path:str ="HR Data.csv") -> pd.DataFrame:
    try:
        df = pd.read_csv(path, encoding="utf-8")
    except FileNotFoundError:
        return pd.DataFrame() 

    df["퇴직"] = df["퇴직여부"].map({"Yes":1, "No":0}).astype("int8")
    df.drop(['직원수', '18세이상'], axis=1, inplace=True)
    
    return df

df = load_df()
if df.empty:
    st.error("데이터가 없습니다. 'HR Data.csv' 파일을 확인하세요.")
    st.stop()

# ===== KPI  =====
# 1) 헤더 & KPI
st.title("퇴직율 분석 및 인사이트")

# KPI(핵심 성과 지표) 계산
n = len(df)
quit_n = int(df["퇴직"].sum())
quit_rate = df["퇴직"].mean()*100
stay_rate = 100 - quit_rate

# KPI 열 배치
k1, k2, k3, k4 = st.columns(4)
k1.metric("전체 직원 수", f"{n:,}명")
k2.metric("퇴직자 수", f"{quit_n:,}명")
k3.metric("유지율", f"{stay_rate:.1f}%")
k4.metric("퇴직율", f"{quit_rate:.1f}%")

# --- 그래프 1: 전공별 퇴직율 (파이 차트) ---
if "전공" in df.columns:
    major_quit_rate = (df.groupby("전공")["퇴직"].mean()*100)
    
    st.subheader("직원 전공별 퇴직율")
    
    fig1, ax1 = plt.subplots(figsize=(10, 5))
    
    ax1.pie(major_quit_rate, labels=major_quit_rate.index, autopct='%.1f%%', startangle=90, colors=sns.color_palette("Set2"))
    ax1.axis('equal')
    
    st.pyplot(fig1)

# --- 그래프 2/3: 두 칼럼으로 분할 ---
c1, c2 = st.columns(2)

# (좌) 그래프 2: 결혼여부별 퇴직율 (도넛 차트)
col_name = "결혼여부"
if col_name in df.columns:
    marital_quit_rate = df.groupby(col_name)["퇴직"].mean()*100
    
    with c1:
        st.subheader("❤️ 결혼여부별 퇴직율")
        fig2, ax2 = plt.subplots(figsize=(6.5, 3.5))
        
        ax2.pie(marital_quit_rate, labels=marital_quit_rate.index, autopct='%.1f%%', 
                wedgeprops={'width': 0.3}, startangle=90, colors=['#ff9999','#66b3ff'])
        ax2.axis('equal')
        
        st.pyplot(fig2)

# (우) 그래프 3: 성별 퇴직율 (막대 그래프)
col_name = "성별"
if col_name in df.columns:
    gender_quit_rate = df.groupby(col_name)["퇴직"].mean()*100
    
    with c2:
        st.subheader("👫 성별 퇴직율")
        fig3, ax3 = plt.subplots(figsize=(6.5, 3.5))
        sns.barplot(x=gender_quit_rate.index, y=gender_quit_rate.values, ax=ax3, palette="Pastel1")
        ax3.set_ylabel("퇴직율(%)")
        ax3.bar_label(ax3.containers[0], fmt="%.1f%%")
        st.pyplot(fig3)
